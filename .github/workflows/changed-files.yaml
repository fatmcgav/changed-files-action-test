name: Telemetry Data Pipeline Release

on:
  push: ~

jobs:
  changed-files:
    runs-on: ubuntu-latest
    name: Test changed-files
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Example 1
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v35
        with:
          dir_names: "true"
          dir_names_max_depth: 1
          json: true

      - name: List all changed files
        run: |
            echo "${{ steps.changed-files.outputs.all_changed_files}}"

    outputs:
      changed_services: ${{ toJSON(steps.changed-files.outputs.all_changed_files) }}


  build-services:
    name: Build and deploy changed services
    needs: changed-files
    strategy:
      fail-fast: false
      matrix:
        changed_services: ${{ fromJSON(needs.changed-files.outputs.changed_services) }}
    uses: ./.github/workflows/build_and_deploy.yaml
    with:
      service: ${{ matrix.changed_services }}

