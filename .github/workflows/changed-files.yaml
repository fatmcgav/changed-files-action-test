name: Telemetry Data Pipeline Release

on:
  push: ~

jobs:
  detect-changed-services:
    runs-on: ubuntu-latest
    name: Test changed-files
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Example 1
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v35
        with:
          dir_names: true
          dir_names_exclude_root: true
          dir_names_max_depth: 1
          files_ignore: |
            .github/*
          json: true

      - name: List all changed files
        id: list-all
        run: |
            echo "changed=${{ steps.changed-files.outputs.all_changed_files }}" >> $GITHUB_OUTPUT

    outputs:
      changed_services: ${{ steps.list-all.outputs.changed }}

  build_deploy_svc-a:
    name: Build and deploy svc-a
    needs: detect-changed-services
    if: ${{ contains(fromJSON(needs.detect-changed-services.outputs.changed_services), 'svc-a') }}
    uses: ./.github/workflows/build_and_deploy.yaml
    with:
      service: svc-a

  build_deploy_svc-b:
    name: Build and deploy svc-b
    needs: detect-changed-services
    if: ${{ contains(fromJSON(needs.detect-changed-services.outputs.changed_services), 'svc-b') }}
    uses: ./.github/workflows/build_and_deploy.yaml
    with:
      service: svc-b

  build_deploy_svc-c:
    name: Build and deploy svc-c
    needs: detect-changed-services
    if: ${{ contains(fromJSON(needs.detect-changed-services.outputs.changed_services), 'svc-c') }}
    uses: ./.github/workflows/build_and_deploy.yaml
    with:
      service: svc-c
